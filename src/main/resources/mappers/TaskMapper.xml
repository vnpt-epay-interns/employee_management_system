<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.Employee_Management_System.mapper.TaskMapper">

    <resultMap id="task" type="com.example.Employee_Management_System.domain.Task">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="completion" column="completion"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="employeeId" column="employee_id"/>
        <result property="estimateHours" column="estimate_hours"/>
        <result property="parentId" column="parent_id"/>
        <result property="priority" column="priority"/>
    </resultMap>

    <select id="getTaskById" resultMap="task">
        SELECT *
        FROM tasks
        WHERE id = #{id}
    </select>

    <resultMap id="user" type="com.example.Employee_Management_System.domain.User">
        <result property="id" column="id"/>
        <result property="firstName" column="first_name"/>
        <result property="lastName" column="last_name"/>
        <result property="email" column="email"/>
        <result property="avatar" column="avatar"/>
        <result property="password" column="password"/>
        <result property="role" column="role"/>
        <result property="isLocked" column="is_locked" javaType="boolean"/>
    </resultMap>

    <select id="getManagerOfEmployee" resultMap="user">
        SELECT u.id         AS id,
               u.first_name AS first_name,
               u.last_name  AS last_name,
               u.email      AS email,
               u.avatar     AS avatar,
               u.password   AS password,
               u.role       AS role,
               u.is_locked  AS is_locked
        FROM users u
        WHERE u.id = (SELECT emp.manager_id
                      FROM employees emp
                      WHERE emp.id = (SELECT t.employee_id
                                      FROM tasks t
                                      WHERE t.id = #{id}
                      )
      )
    </select>

    <select id="getManagerOfTask" resultMap="user">
        SELECT u.id         AS id,
               u.first_name AS first_name,
               u.last_name  AS last_name,
               u.email      AS email,
               u.avatar     AS avatar,
               u.password   AS password,
               u.role       AS role,
               u.is_locked  AS is_locked
        FROM users u
        WHERE u.id = (SELECT emp.manager_id
                      FROM employees emp
                      WHERE emp.id = (SELECT t.employee_id
                                      FROM tasks t
                                      WHERE t.id = #{id}
                      )
      )

    </select>

    <select id="getEmployeeOfTask" resultMap="user">
        SELECT u.id         AS id,
               u.first_name AS first_name,
               u.last_name  AS last_name,
               u.email      AS email,
               u.avatar     AS avatar,
               u.password   AS password,
               u.role       AS role,
               u.is_locked  AS is_locked
        FROM users u
        WHERE u.id = (SELECT t.employee_id
                      FROM tasks t
                      WHERE t.id = #{id})

    </select>

    <select id="getTaskByIdAndEmployeeId" resultMap="task">
        SELECT * FROM tasks WHERE id = #{id} AND employee_id = #{employeeId};
    </select>

    <resultMap id="task_user_info" type="com.example.Employee_Management_System.dto.response.TaskDTO">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="completion" column="completion"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="employeeId" column="employee_id"/>
        <result property="estimateHours" column="estimate_hours"/>
        <result property="parentId" column="parent_id"/>
        <result property="priority" column="priority"/>
        <result property="projectId" column="project_id"/>
        <result property="employeeId" column="employee_id"/>
        <result property="employeeName" column="employee_name"/>
    </resultMap>
    <select id="getTasks" resultMap="task_user_info">
        SELECT t.id AS id,
               t.title AS title,
               t.description AS description,
               t.status AS status,
               t.completion AS completion,
               t.start_date AS start_date,
               t.end_date AS end_date,
               t.employee_id AS employee_id,
               t.estimate_hours AS estimate_hours,
               t.parent_id AS parent_id,
               t.priority AS priority,
               t.project_id AS project_id,
               CONCAT(u.first_name, ' ', u.last_name) AS employee_name
        FROM tasks t
        JOIN users u ON t.employee_id = u.id
    </select>

    <select id="getTaskAndEmployeeInfo" resultMap="task_user_info">
        SELECT t.id AS id,
               t.title AS title,
               t.description AS description,
               t.status AS status,
               t.completion AS completion,
               t.start_date AS start_date,
               t.end_date AS end_date,
               t.employee_id AS employee_id,
               t.estimate_hours AS estimate_hours,
               t.parent_id AS parent_id,
               t.priority AS priority,
               t.project_id AS project_id,
               CONCAT(u.first_name, ' ', u.last_name) AS employee_name
        FROM tasks t
        JOIN users u ON t.employee_id = u.id
        WHERE t.id = #{id}
    </select>

    <resultMap id="tasks_number_report" type="com.example.Employee_Management_System.dto.response.TaskDTO">
        <result property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="completion" column="completion"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="employeeId" column="employee_id"/>
        <result property="estimateHours" column="estimate_hours"/>
        <result property="parentId" column="parent_id"/>
        <result property="priority" column="priority"/>
        <result property="projectId" column="project_id"/>
        <result property="employeeId" column="employee_id"/>
        <result property="employeeName" column="employee_name"/>
        <result property="numberReports" column="number_reports"/>
    </resultMap>
    <select id="getTasksByEmployeeId" resultMap="tasks_number_report">
        SELECT t.id,
               t.title,
               t.description,
               t.status,
               t.completion,
               t.start_date,
               t.end_date,
               t.employee_id,
               t.estimate_hours,
               t.parent_id,
               t.priority,
               t.project_id,
               t.employee_name,
               count(r.id) as number_reports
        FROM(SELECT t.id,
                    t.title,
                    t.description,
                    t.status,
                    t.completion,
                    t.start_date,
                    t.end_date,
                    t.employee_id,
                    t.estimate_hours,
                    t.parent_id,
                    t.priority,
                    t.project_id,
                    CONCAT(u.first_name, ' ', u.last_name) AS employee_name
             FROM employees e
                      JOIN users u on u.id = e.id
                      JOIN tasks t on t.employee_id = e.id
             WHERE e.id = #{employeeId}) t
                left join reports r on r.task_id = t.id
        group by t.id
    </select>

    <select id="getTasksByParentTask" resultMap="task">
        SELECT * FROM tasks WHERE parent_task = #{parentTask};
    </select>
</mapper>
